{% extends 'base.html' %}

{% block content %}
<div id="app-respondent">
{% if error %}
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="jumbotron rounded-0">
            <h1 class="display-4 text-center">Witaj!</h1>
            <p class="lead">Niestety nie możemy wyświetlić ci tej ankiety, ponieważ jest ona dostepna tylko dla zalogowanych użytkowników.</p>
            <hr class="my-4">
            <a class="btn btn-outline-info " href="{% url 'login' %}" role="button">Przejdz do strony logowania</a>
        </div>
    </div>
{% else %}

<div class='row justify-content-center'>
    <div class="col-6 ">
        <div class='text-center py-3'>
            <h2>{{questionnaire.name}}</h2>
        </div>
        <div class="text-left d-flex justify-content-between px-2">
            <h6> <small>Stworzona przez: {{questionnaire.creator.username}} </small></h6>
            <h6> <small> {{questionnaire.updated_at|date:"D d m Y"}}</small></h6>
        </div>
        <form action="{% url 'display_questionnaire' questionnaire_code=questionnaire.code%}" method="POST">
            {% csrf_token %}
            {% for question in questionnaire.question_set.all %}
            <div class="bg-white p-3 mb-1  rounded shadow-sm">
                <h5>{{question.contents}}</h5>
                <div>
                    <ul>
                    {% for choice in question.choice_set.all %}
                        {% if question.type == 'single-choice' %}
                        <div class="custom-control custom-radio">
                            <input type="radio" id="customRadio-{{choice.id}}"  value="{{choice.id}}"  name="{{question.id}}" class="custom-control-input">
                            <label class="custom-control-label" for="customRadio-{{choice.id}}">{{choice.contents}}</label>
                        </div>
                        {% elif question.type == 'multiple-choice' %}
                        <div class="custom-control custom-checkbox checkbox-dark">
                            <input type="checkbox" class="custom-control-input " name="{{question.id}}" value="{{choice.id}}"  id="customCheck-{{choice.id}}">
                            <label class="custom-control-label" for="customCheck-{{choice.id}}">{{choice.contents}}</label>
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% if question.type == 'number' %}
                    <div class="form-group">
                        <input type="number" class="form-control"  name="{{question.id}}" id="{{question.id}}" placeholder="Wpisz liczbe">
                    </div>
                    {% elif question.type == 'text' %}
                        <div class="form-group">
                            <textarea class="form-control" name="{{question.id}}" id="{{question.id}}" rows="3"></textarea>
                        </div>
                    {% endif %}
                    </ul>
                </div>
            </div>
        {% endfor %}
        <div class='mt-4'>
            <button class='btn btn-primary px-3'>Wyślij</button>
        </div>
        </form>
    </div>
</div>

<div class='row justify-content-center'>
    <div class="col-6 ">
        <div class='text-center py-3'>
            <h2>{{questionnaire.name}}</h2>
        </div>
        <div class="text-left d-flex justify-content-between px-2">
            <h6> <small>Data stworzenia: {{questionnaire.updated_at|date:"D d m Y"}}</small></h6>
        </div>
            <div  v-for="(question, index) in questionnaire.questions" :key="question.id" class="bg-white p-3 mb-1  rounded shadow-sm">
                <h5>[[question.contents]]</h5>
                <div>
                    <!-- closed questions -->
                    <ul v-for="choice in question.choices" :key="choice.id" >
                        <div  v-if="question.type === 'single-choice'" class="custom-control custom-radio">
                            <input type="radio" :id="choice.id"  :value="choice.id" v-on:click="addRadio(question.id,choice.id)"  :name="question.id" class="custom-control-input">
                            <label class="custom-control-label" :for="choice.id">[[choice.contents]]</label>
                        </div>
                        
                        <div v-else-if="question.type === 'multiple-choice'" class="custom-control custom-checkbox checkbox-dark">
                            <input type="checkbox" :name="question.id" :id="choice.id" class="custom-control-input" :value="choice.id"  v-on:click="addCheckbox(question.id,choice.id)" :id="choice.id">
                            <label class="custom-control-label" :for="choice.id">[[choice.contents]]</label>
                        </div>
                    </ul>
                    
                    <!-- open questions -->
                    <div v-if="question.type == 'number'" class="form-group">
                        
                        <input type="number" class="form-control"  v-model="question.answer"placeholder="Wpisz liczbe">
                    </div>
                    <div v-else-if="question.type == 'text'" class="form-group">
                        <textarea class="form-control" id="exampleFormControlTextarea1" v-model="question.answer" rows="3"></textarea>
                    </div>
                </div>
            </div>
        <div class='mt-4'>
            <button class='btn btn-primary px-3' v-on:click="sent">Wyślij</button>
        </div>
        <div v-if="show"> 
            <ul v-for="question in questionnaire.questions">
                <li>[[question.contents]]-[[question.id]]</li>
                <li>[[question.answer]]</li>
            </ul>
        </div>
    </div>

</div>

</div>
{% endif %}

{% block script %}
<script>
    function sendRequest(url,method,data){
        let r  = axios({
            method: method,
            url: url,
            data: data,
            headers: {
                'X-CSRFToken' : '{{csrf_token}}',
                'Content-Type' : 'application/json'
            }
        })
        return r;
    }
    var appDelete = new Vue({
        el: '#app-respondent',
        delimiters:['[[',']]'],
        data(){
            return{
                questionnaire:[],
                answers:[],
                show:false,
            }
        },
        methods: {
            addRadio(q_id, ch_id){
                for(let [i,question] of this.questionnaire.questions.entries())
                {
                    if(question.id === q_id){
                        question.answer = Array.of(ch_id)
                        break;
                    }
                }
            },
            addCheckbox(q_id, ch_id){
                for(let [i,question] of this.questionnaire.questions.entries())
                {
                    if(question.id === q_id){
                        let choiceIndex = question.answer.findIndex(el=> el === ch_id);
                        if (choiceIndex === -1){
                            question.answer.push(ch_id);
                        }
                        else{
                            question.answer.splice(choiceIndex,1)
                        }
                        break;
                    }
                }
            },
            sent(){
                this.show = true;
            },
            setAnswer(){
                for( let question of this.questionnaire.questions ){
                    Vue.set(question, 'answer', []);
                }
            },
            async getQuestionnaire(){
                let response = await axios
                .get('{% url "detail_questionnaire_api" id=questionnaire.id %}')
                .then(response => {
                    this.questionnaire = response.data.data.questionnaire;
                    return true
                }).catch(err=>{ 
                    console.log(err);
                    return false
                })
                if(response){
                    this.setAnswer();
                }
            }      
            
        },
        created() {
            this.getQuestionnaire()
        },
    })
</script>
{% endblock %}
{% endblock %}